<!DOCTYPE html>
<html>
<head>
  <title>Customer Dashboard</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 300px; width: 80%; margin:auto; margin-bottom:20px; }
    table { width: 90%; margin:auto; border-collapse: collapse; margin-bottom: 20px; }
    th, td { border: 1px solid #aaa; padding: 8px; text-align: center; }
    th { background-color: #f0f0f0; }
    form { text-align: center; margin-bottom: 20px; }
    input { margin: 5px; padding: 8px; width: 250px; }
    button { padding: 8px 16px; background-color: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; }
    button:hover { background-color: #45a049; }
  </style>
</head>
<body>
<h2 style="text-align:center;">Customer Dashboard</h2>
<div id="map"></div>

<form id="customerForm">
  <input type="text" id="name" placeholder="Your Name" required><br>
  <input type="text" id="vehicleNo" placeholder="Vehicle No" required><br>
  <input type="text" id="problem" placeholder="Problem Description" required><br>
  <input type="text" id="landmark" placeholder="Nearby Landmark" required><br>
  <input type="text" id="phone" placeholder="Phone Number" required><br>
  <button type="submit">Send Request</button>
</form>

<h3 style="text-align:center;">Request Status:</h3>
<table id="statusTable">
  <tr>
    <th>Name</th>
    <th>Vehicle</th>
    <th>Problem</th>
    <th>Landmark</th>
    <th>Phone</th>
    <th>Status</th>
  </tr>
</table>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
let latitude, longitude;
let map, marker;

// Initialize map
function initMap(lat, lon) {
  map = L.map('map').setView([lat, lon], 15);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);
  marker = L.marker([lat, lon]).addTo(map).bindPopup("You are here").openPopup();
}

// Get live location
navigator.geolocation.getCurrentPosition(pos => {
  latitude = pos.coords.latitude;
  longitude = pos.coords.longitude;
  initMap(latitude, longitude);
});

// Submit request
document.getElementById('customerForm').addEventListener('submit', async e => {
  e.preventDefault();
  const data = {
    customerName: document.getElementById('name').value,
    vehicleNo: document.getElementById('vehicleNo').value,
    problem: document.getElementById('problem').value,
    landmark: document.getElementById('landmark').value,
    phoneNo: document.getElementById('phone').value,
    latitude, longitude
  };

  try {
    const response = await fetch('http://localhost:8080/api/customer/request', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(data)
    });
    if (response.ok) {
      alert('✅ Request sent successfully!');
      document.getElementById('customerForm').reset(); // clear fields
    } else {
      alert('❌ Failed to send request. Please try again.');
    }
  } catch (error) {
    alert('⚠️ Error: Could not connect to the server.');
    console.error(error);
  }
});

// Load request status
async function loadStatus() {
  try {
    const res = await fetch('http://localhost:8080/api/customer/all');
    const data = await res.json();
    const table = document.getElementById('statusTable');
    table.innerHTML = `
      <tr>
        <th>Name</th><th>Vehicle</th><th>Problem</th>
        <th>Landmark</th><th>Phone</th><th>Status</th>
      </tr>`;
    data.forEach(req => {
      const color = req.status === 'ACCEPTED' ? 'green' :
                    req.status === 'DENIED' ? 'red' : 'orange';
      table.innerHTML += `
        <tr>
          <td>${req.customerName}</td>
          <td>${req.vehicleNo}</td>
          <td>${req.problem}</td>
          <td>${req.landmark}</td>
          <td>${req.phoneNo}</td>
          <td style="color:${color}; font-weight:bold;">${req.status}</td>
        </tr>`;
    });
  } catch (err) {
    console.error("Error loading status:", err);
  }
}

setInterval(loadStatus, 5000);
loadStatus();
</script>
</body>
</html>
